<!doctype html>
<html lang="zh-CN">
<head>
    <meta charset="utf-8">
    <meta http-equiv="cache-control" content="no-cache, must-revalidate">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="format-detection" content="telephone=no" />
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>控制台 - JavaScript Simple Console</title>
    <link rel="stylesheet" href="css/g.css">
    <link rel="stylesheet" href="cm/codemirror.css">
    <style type="text/css">
        #console{
            float: left;
            width: 500px;
            border: 1px solid #eee;
        }
        #output{
            float: left;
            width: 500px;
            border: 1px solid #eee;
            background-color: #000;
            padding: .4em;
            white-space: pre;
            color: rgb(40,255,20);
            display: block;
            resize: none;
            font-family: monospace;
            font-size: 13px;
        }
        #op_zone{
            margin-left: 5px;
            width: 120px;
            float: left;
        }
        .clear{
            clear: both;
        }
        #desc{
            padding-top:20px;
        }
        #text{
            display: none;
        }
        .CodeMirror{
            background-color: #fff;
            cursor: text;
        }
        .CodeMirror-scroll,.CodeMirror,#console,#output,#op_zone{
            height: 500px !important;
        }
        footer{
            padding-top: 13px;
            border-top: 1px solid #626557;
            margin-top: 20px;
        }
	</style>
</head>
<body>
    <div id="wrapper">
        <header><h1>JavaScript Simple Console</h1></header>
        <div id="console">
            <textarea id="text" name="text">alert('Hello World')</textarea>
        </div>
        <div id="op_zone">
            <div style="margin-top: 250px;">
                <button id="sub">运行代码</button>
            </div>
        </div>
        <textarea id="output" readonly></textarea>
        <div class="clear"></div>
        <div id="desc">
            <strong>需要调试的页面引用下面的脚本,在PC上打开本页面输入代码远程执行并获取执行结果.<a href="#" target="_blank" id="debug">点此</a>开始测试</strong>
            <p>
                &lt;script src="http://<script>document.write(location.host)</script>/remote.js?<span id="rtx"></span>"&gt;&lt;/script&gt;</em>
            </p>
        </div>
        <footer><h4>by simongfxu</h4></footer>
    </div>
    <script type="text/javascript" src="js/jquery.js"></script>
    <script src="cm/codemirror.js"></script>
    <script src="cm/javascript.js"></script>
	<script type="text/javascript">
        var username = location.search && encodeURIComponent(location.search.slice(1)), source
        $(function(){
            if(!username){
                $('#wrapper').html('<p>请在url上附加监听的用户,形式:?你的RTX名称</p>')
                return
            }
            $('#debug').attr('href', 'tests/debug.html?' + username)
            $('#rtx').text(username)

            /**
             * 提交控制台脚本
             */
            var runScript = function (){
                var script = editor.getValue()
                if(!script || !username){
                    alert('执行脚本和监听用户都不能为空')
                    return
                }
                if(source && source.readyState == source.OPEN){
                    var xhr = new XMLHttpRequest(), form = new FormData()
                    form.append('content', encodeURIComponent(script))
                    xhr.timeout = 5000
                    xhr.addEventListener('load', function(){
                        $('#output').val('等待远程执行结果返回...')
                    })
                    xhr.addEventListener('timeout', function(e){
                        alert('请求超时')
                    })
                    xhr.addEventListener('error', function(e){
                        console.log('请求出错')
                    })
                    xhr.open('POST','./input?' + username, true)
                    xhr.send(form)
                }else{
                    alert('连接已经被关闭,点击确定刷新页面继续调试')
                    location.reload()
                }
            }

            /**
             * CodeMirror语法高亮
             */
            var editor = CodeMirror.fromTextArea($("#text")[0], {
                mode: "javascript",
                lineNumbers: true,
                lineWrapping: true,
                onCursorActivity: function() {
                    editor.setLineClass(hlLine, null, null);
                    hlLine = editor.setLineClass(editor.getCursor().line, null, "activeline");
                },
                onKeyEvent : function(self,e){
                    if(e.type == 'keydown'){
                        if(e.ctrlKey && e.which == 13){
                            e.preventDefault()
                            runScript()
                        }
                    }
                }
            })
            var hlLine = editor.setLineClass(0, "activeline")

            var closeConnection = function(msg){
                //TODO 不知道为什么服务器的close事件不一定能正确响应,更像是在响应timeout事件
                source.close()
                source = null
                document.write(msg)
                document.title = '-__-你被T了'
            }

            /**
             * Server Push,接受远程执行结果
             */
            source = new EventSource('./rev_polling?' + username)
            source.addEventListener('message', function(e){
                console.log('接受远程数据:',e)
                $('#output').val(decodeURIComponent(e.data))
            })
            source.addEventListener('kicked',function(e){
                closeConnection('为了防止控制台过多干扰调试结果,同一时间段只允许使用一个控制台.刷新页面可以抢夺当前用户的控制权')
            })
            source.addEventListener('max', function(e){
                closeConnection('当前访问人数超出了服务器限制.刷新页面可继续使用')
            })
            setTimeout(function(){
                closeConnection('为了节约服务器资源,每个长连接最多持续5分钟.刷新页面后继续使用')
            }, 5*1000*60)

            $('#text').focus()
            $('#sub').on('click', runScript)
        })
	</script>
</body>
</html>