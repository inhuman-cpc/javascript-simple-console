<!doctype html>
<html lang="zh-CN">
<head>
    <meta charset="utf-8">
    <meta http-equiv="cache-control" content="no-cache, must-revalidate">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="format-detection" content="telephone=no" />
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>控制台 - JavaScript Simple Console</title>
    <link rel="stylesheet" href="css/g.css">
    <link rel="stylesheet" href="cm/codemirror.css">
    <style type="text/css">
        #console{
            float: left;
            height: 560px;
            width: 500px;
            border: 1px solid #eee;
        }
        #output{
            float: left;
            height: 560px;
            width: 500px;
            border: 1px solid #eee;
            background-color: #000;
            padding: .4em;
            white-space: pre;
            color: rgb(40,255,20);
            display: block;
            resize: none;
            font-family: monospace;
            font-size: 13px;
        }
        #op_zone{
            margin-left: 5px;
            width: 120px;
            float: left;
            height: 560px;
        }
        .clear{
            clear: both;
        }
        #desc{
            padding-top:20px;
        }
        #text{
            display: none;
        }
        .CodeMirror{
            height: 560px;
            background-color: #fff;
            cursor: text;
        }
        .CodeMirror-scroll{
            height: 560px !important;
        }
	</style>
</head>
<body>
    <div id="wrapper">
        <header><h1>JavaScript Simple Console</h1></header>
        <div id="console">
            <textarea id="text" name="text">alert('Hello World')</textarea>
        </div>
        <div id="op_zone">
            <div style="margin-top: 250px;">
                <button id="sub">运行代码</button>
            </div>
        </div>
        <textarea id="output" readonly></textarea>
        <div class="clear"></div>
        <div id="desc">
            <strong>需要调试的页面引用下面的脚本,在PC上打开本页面输入代码远程执行并获取执行结果.</strong>
            <p>
                &lt;script src="http://<script>document.write(location.host)</script>/remote.js?{RTX_NAME}"&gt;&lt;/script&gt;</em>
            </p>
            <strong>你可以使用<a href="#" target="_blank" id="debug">这个页面</a>进行一些基本的测试工作</strong>
            <p></p>
            <strong>你可以使用<a href="./manager.html" target="_blank">这个页面</a>管理控制台和调试的页面</strong>
        </div>
        <footer><h4>by simongfxu</h4></footer>
    </div>
    <script type="text/javascript" src="js/jquery.js"></script>
    <script src="cm/codemirror.js"></script>
    <script src="cm/javascript.js"></script>
	<script type="text/javascript">
        var username = location.search && encodeURIComponent(location.search.slice(1)), source
        $(function(){
            if(!username){
                $('#wrapper').html('<p>请在url上附加监听的用户,比如?simongfxu</p>')
                return
            }
            $('#debug').attr('href', 'tests/debug.html?' + username)

            var runScript = function (){
                var script = editor.getValue()
                if(!script || !username){
                    alert('执行脚本和监听用户都不能为空')
                    return
                }
                var xhr = new XMLHttpRequest(), form = new FormData()
                form.append('content', encodeURIComponent(script))
                xhr.onload = function(){
                    $('#output').val('等待远程执行结果返回...')
                }
                xhr.open('POST','./input?' + username, true)
                xhr.send(form)
            }

            var editor = CodeMirror.fromTextArea($("#text")[0], {
                mode: "javascript",
                lineNumbers: true,
                lineWrapping: true,
                onCursorActivity: function() {
                    editor.setLineClass(hlLine, null, null);
                    hlLine = editor.setLineClass(editor.getCursor().line, null, "activeline");
                }
            })
            var hlLine = editor.setLineClass(0, "activeline")

            $('#text').focus()
            //用于接受脚本执行结果
            $('#sub').on('click', runScript)
            source = new EventSource('./rev_polling?' + username)
            source.onmessage = function(e){
                console.log('接受远程数据:',e)
                if(e.data == 'CLOSE'){
                    source.close()
                    document.write('为了防止控制台过多干扰调试结果,同一时间段只允许使用一个控制台.\r\n刷新页面可以抢夺控制台使用权')
                    document.title = '-__-你被T了'
                }else{
                    $('#output').val(decodeURIComponent(e.data))
                }
            }
        })
	</script>
</body>
</html>