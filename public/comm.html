<!doctype html>
<html>
<head>
	<meta charset="utf-8">
    <meta http-equiv="cache-control" content="no-cache, must-revalidate">
</head>
<body>
<!--this page is used for receiving the server push messages-->
	<script type="text/javascript">
        ;~function(W,D){
            if(!W.EventSource){
                alert('EventSource Not Support')
                return
            }
            var username = location.search.slice(1)
            W.onmessage = function(e){
                var xhr = new XMLHttpRequest(), form = new FormData()
                xhr.onload = function(){
                    var ret = JSON.parse(this.responseText)
                    console.log(ret.ret == 0?'result has been sent!':('sent fail!!!' + ret.msg))
                }
                form.append('result', e.data)
                xhr.open('POST', './output?' + username,true)
                xhr.send(form)
            }
            var eventSource = new EventSource('./send_polling?' + username)
            eventSource.onmessage = function(e){
                console.log('script to run : ' + e.data);
                try{
                    //TODO local file test
                    parent.postMessage(e.data, '*')
                }catch(e){
                    console.log('post message failed : file:///????')
                }
            }
        }(window,document)
	</script>
</body>
</html>